<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Model Development (Binary Outcomes)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="part1.2_precision_medicine_files/libs/clipboard/clipboard.min.js"></script>
<script src="part1.2_precision_medicine_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="part1.2_precision_medicine_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="part1.2_precision_medicine_files/libs/quarto-html/popper.min.js"></script>
<script src="part1.2_precision_medicine_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="part1.2_precision_medicine_files/libs/quarto-html/anchor.min.js"></script>
<link href="part1.2_precision_medicine_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="part1.2_precision_medicine_files/libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="part1.2_precision_medicine_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="part1.2_precision_medicine_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="part1.2_precision_medicine_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#key-sections" id="toc-key-sections" class="nav-link active" data-scroll-target="#key-sections">Key Sections :</a>
  <ul class="collapse">
  <li><a href="#choosing-the-model-strategy" id="toc-choosing-the-model-strategy" class="nav-link" data-scroll-target="#choosing-the-model-strategy">1. Choosing The Model Strategy</a>
  <ul class="collapse">
  <li><a href="#third-model-ridge-regression" id="toc-third-model-ridge-regression" class="nav-link" data-scroll-target="#third-model-ridge-regression">Third Model : Ridge Regression</a></li>
  <li><a href="#model-comparison" id="toc-model-comparison" class="nav-link" data-scroll-target="#model-comparison">Model Comparison</a></li>
  </ul></li>
  <li><a href="#what-to-look-for-in-the-results" id="toc-what-to-look-for-in-the-results" class="nav-link" data-scroll-target="#what-to-look-for-in-the-results">What to look for in the results:</a></li>
  <li><a href="#calculate-apparent-performance-of-the-models" id="toc-calculate-apparent-performance-of-the-models" class="nav-link" data-scroll-target="#calculate-apparent-performance-of-the-models">Calculate Apparent Performance of The Models</a>
  <ul class="collapse">
  <li><a href="#what-each-metric-means" id="toc-what-each-metric-means" class="nav-link" data-scroll-target="#what-each-metric-means">What Each Metric Means</a></li>
  </ul></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation">Interpretation</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Model Development (Binary Outcomes)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>After preparing the data, the next step will be modelling. Modeling helps us understand how variables relate to each other. Models allow us to predict outcomes for new observations. Any prediction function demonstrates this - it takes new patient data and estimates their probability of the outcome occurring. This is crucial for clinical decision-making.</p>
<section id="key-sections" class="level1">
<h1>Key Sections :</h1>
<p>This part 1.2 Modelling will consist of some sections :</p>
<ul>
<li>Choosing a modelling strategy</li>
<li>Building The Model</li>
<li>Assessing model performance including AUC, Calibration Plot</li>
<li>Assessing performance using validation metrics</li>
</ul>
<section id="choosing-the-model-strategy" class="level2">
<h2 class="anchored" data-anchor-id="choosing-the-model-strategy">1. Choosing The Model Strategy</h2>
<p>During this section, we will cover three models, including logistic regression with splines, GAM, Ridge.</p>
<p>The first step is load the neccessary libarary</p>
<p>For the first step, load the datasets from previous part.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load previous datasets</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>imputed1 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"imputed_datasets.rds"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">as.data.frame</span>(imputed1[[<span class="dv">1</span>]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  y         x1         x2 x3 x4 x5          z1          z2  z3 z4 z5 clust
1 0  0.1145885 -1.2601838  0  0  2  0.26110540  1.18734162   0  0  2     1
2 0  0.6705792  0.7661398  0  0  3 -0.09013217 -0.98427143   0  0  4     1
3 0  0.9088665  0.7075909  1  1  3  0.38699219 -0.60442719   0  0  2     1
4 0  0.5760474  0.4124591  0  0  1 -1.85926106 -0.08279744   0  0  4     1
5 0 -0.6488458  0.1137889  0  1  2 -0.72169765 -1.37296563   0  0  2     1
6 0  1.5415047  0.5503613  0  0  4  1.30673919  0.53601209 0.5  0  3     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data.bin <span class="ot">=</span> <span class="fu">as.data.frame</span>(imputed1[[<span class="dv">1</span>]])</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>n.impute <span class="ot">&lt;-</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="baseline-for-predictions" class="level4">
<h4 class="anchored" data-anchor-id="baseline-for-predictions">Baseline for Predictions</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>new.patient <span class="ot">&lt;-</span> new.patient <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x1=</span><span class="sc">-</span><span class="fl">0.3</span>, <span class="at">x2=</span><span class="sc">-</span><span class="fl">0.5</span>, <span class="at">x3=</span><span class="dv">1</span>, <span class="at">x4=</span><span class="dv">1</span>, <span class="at">x5=</span><span class="dv">2</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>new.logit <span class="ot">&lt;-</span> <span class="fu">with</span>(new.patient,<span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span>x1<span class="fl">+0.1</span><span class="sc">*</span>x1<span class="sc">^</span><span class="dv">2</span><span class="fl">+0.2</span><span class="sc">*</span>x2<span class="fl">-0.05</span><span class="sc">*</span>x2<span class="sc">^</span><span class="dv">2</span><span class="fl">+0.1</span><span class="sc">*</span>(x3<span class="sc">==</span><span class="dv">2</span>)<span class="sc">+</span><span class="fl">0.2</span><span class="sc">*</span>(x4<span class="sc">==</span><span class="dv">2</span>)<span class="sc">+</span><span class="fl">0.2</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">*</span>(x5<span class="sc">==</span><span class="dv">2</span>)<span class="sc">-</span><span class="fl">0.1</span><span class="sc">*</span>(x5<span class="sc">==</span><span class="dv">3</span>)<span class="sc">+</span><span class="fl">0.2</span><span class="sc">*</span>(x5<span class="sc">==</span><span class="dv">4</span>))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># this is the true log odds</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(new.logit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1282851</code></pre>
</div>
</div>
</section>
<section id="first-method-regression-spline" class="level4">
<h4 class="anchored" data-anchor-id="first-method-regression-spline">First Method : Regression Spline</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>regression.splines<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.impute){ </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    regression.splines[[i]]<span class="ot">&lt;-</span> <span class="fu">lrm</span>(y<span class="sc">~</span><span class="fu">rcs</span>(x1,<span class="dv">3</span>)<span class="sc">+</span><span class="fu">rcs</span>(x2,<span class="dv">3</span>)<span class="sc">+</span>x3<span class="sc">+</span>x4<span class="sc">+</span>x5, <span class="at">data=</span>imputed1[[i]]) </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This creates multiple logistic regression models (one for each imputed dataset):</p>
<ul>
<li><code>lrm()</code>&nbsp;fits logistic regression models</li>
<li><code>rcs(x1,3)</code>&nbsp;and&nbsp;<code>rcs(x2,3)</code>&nbsp;create restricted cubic splines with 3 knots for variables x1 and x2</li>
<li>x3, x4, x5 are included as linear terms</li>
<li>Each model is fitted on a different imputed dataset (<code>imputed1[[i]]</code>)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>spl1<span class="ot">&lt;-</span><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">x1=</span><span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>, <span class="fl">0.1</span>),</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">logit.py=</span><span class="fu">Predict</span>(regression.splines[[i]], <span class="at">x1=</span><span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>,<span class="fl">0.1</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">x2=</span><span class="dv">0</span>, <span class="at">x3=</span><span class="dv">1</span>, <span class="at">x4=</span><span class="dv">1</span>, <span class="at">x5=</span><span class="dv">2</span>)<span class="sc">$</span>yhat),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x=</span>x1, <span class="at">y=</span>logit.py)) <span class="sc">+</span> <span class="fu">geom_smooth</span>()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>spl2<span class="ot">&lt;-</span><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">x2=</span><span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>, <span class="fl">0.1</span>),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">logit.py=</span><span class="fu">Predict</span>(regression.splines[[i]], <span class="at">x1=</span><span class="dv">1</span>, <span class="at">x2=</span><span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>,<span class="fl">0.1</span>), </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x3=</span><span class="dv">1</span>, <span class="at">x4=</span><span class="dv">1</span>, <span class="at">x5=</span><span class="dv">2</span>)<span class="sc">$</span>yhat),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x=</span>x2, <span class="at">y=</span>logit.py)) <span class="sc">+</span> <span class="fu">geom_smooth</span>()</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(spl1,spl2,<span class="at">ncol=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="part1.2_precision_medicine_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This creates partial effect plots showing:</p>
<ul>
<li>How the log-odds (logit) changes with x1 (holding other variables constant)</li>
<li>How the log-odds changes with x2 (holding other variables constant)</li>
<li>The smooth curves reveal the non-linear relationships captured by the splines</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>prediction.lr <span class="ot">&lt;-</span> <span class="cf">function</span>(new.patient, <span class="at">single.fit =</span> <span class="cn">NULL</span>, <span class="at">multiple.fit =</span> <span class="cn">NULL</span>){</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(multiple.fit)){</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle multiple imputation models</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        mygrid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">k =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(new.patient)[<span class="dv">1</span>], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(multiple.fit))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        ff <span class="ot">&lt;-</span> <span class="cf">function</span>(k,i){</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">with</span>(new.patient, <span class="fu">Predict</span>(multiple.fit[[i]], <span class="at">x1=</span> x1[k], <span class="at">x2 =</span> x2[k],</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">x3=</span> x3[k], <span class="at">x4=</span> x4[k], <span class="at">x5=</span> x5[k])<span class="sc">$</span>y) </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        prediction_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">mapply</span>(ff, mygrid<span class="sc">$</span>k, mygrid<span class="sc">$</span>i),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">nrow =</span> <span class="fu">dim</span>(new.patient)[<span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">length</span>(multiple.fit))</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        prediction <span class="ot">&lt;-</span> <span class="fu">apply</span>(prediction_matrix, <span class="dv">1</span>, mean)  <span class="co"># Average across imputations</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(single.fit)){</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle single model</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        ff <span class="ot">&lt;-</span> <span class="cf">function</span>(k){</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">with</span>(new.patient, <span class="fu">Predict</span>(single.fit, <span class="at">x1=</span> x1[k], <span class="at">x2 =</span> x2[k], </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>                <span class="at">x3=</span> x3[k], <span class="at">x4=</span> x4[k], <span class="at">x5=</span> x5[k])<span class="sc">$</span>y) </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        prediction <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(new.patient)[<span class="dv">1</span>], ff) </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(prediction)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This flexible function:</p>
<ul>
<li>Can handle either a single model or multiple imputation models</li>
<li>For multiple models: generates predictions from each model and averages them (Rubin’s rules)</li>
<li>For single models: generates predictions directly</li>
<li>Returns predictions on the log-odds scale</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="fu">prediction.lr</span>(new.patient, <span class="at">multiple.fit =</span> regression.splines))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0978198</code></pre>
</div>
</div>
<p>The predicted probability is only differ 0.2 from the baseline predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>complete.data <span class="ot">&lt;-</span> data.bin[<span class="fu">complete.cases</span>(data.bin[,<span class="fu">c</span>(<span class="st">"x1"</span>,<span class="st">"x2"</span>,<span class="st">"x3"</span>,<span class="st">"x4"</span>,<span class="st">"x5"</span>,<span class="st">"y"</span>)]),]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>predicted.lr <span class="ot">&lt;-</span> <span class="fu">prediction.lr</span>(complete.data, <span class="at">multiple.fit =</span> regression.splines) </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># these are patients with fully observed data</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">p=</span><span class="fu">expit</span>(predicted.lr)), <span class="fu">aes</span>(<span class="at">x=</span>p)) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>() <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">color=</span><span class="st">"black"</span>, <span class="at">fill=</span><span class="st">"white"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="part1.2_precision_medicine_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="second-method-gam" class="level4">
<h4 class="anchored" data-anchor-id="second-method-gam">Second Method : GAM</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fit.gam <span class="ot">&lt;-</span> <span class="fu">list</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creates an empty list called&nbsp;<code>fit.gam</code>&nbsp;that will store multiple GAM model objects - one for each imputed dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.impute){</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  fit.gam[[i]] <span class="ot">&lt;-</span> <span class="fu">gam</span>(y<span class="sc">~</span>x3<span class="sc">+</span>x4<span class="sc">+</span>x5<span class="sc">+</span><span class="fu">s</span>(x1)<span class="sc">+</span><span class="fu">s</span>(x2), <span class="at">data =</span> imputed1[[i]],</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">family=</span>binomial)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This loop fits a GAM to each of the&nbsp;<code>n.impute</code>&nbsp;imputed datasets:</p>
<ul>
<li><code>y</code>&nbsp;is the binary outcome variable (since&nbsp;<code>family=binomial</code>)</li>
<li><code>x3</code>,&nbsp;<code>x4</code>,&nbsp;<code>x5</code>&nbsp;are included as linear terms</li>
<li><code>s(x1)</code>&nbsp;and&nbsp;<code>s(x2)</code>&nbsp;are smooth terms (non-linear relationships)</li>
<li>Each model is fitted to a different imputed dataset&nbsp;<code>imputed1[[i]]</code></li>
<li>Results are stored in&nbsp;<code>fit.gam[[i]]</code></li>
</ul>
<p>Defines <code>prediction.gam</code> function that can make predictions using either:</p>
<ul>
<li><code>single.fit</code>: one GAM model</li>
<li><code>multiple.fit</code>: multiple GAM models (for multiple imputation)</li>
<li><code>new.patient</code>: new data to make predictions on</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>prediction.gam <span class="ot">&lt;-</span> <span class="cf">function</span>(new.patient, <span class="at">single.fit =</span> <span class="cn">NULL</span>, <span class="at">multiple.fit =</span> <span class="cn">NULL</span>){</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(multiple.fit)){</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>      mygrid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">k =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(new.patient)[<span class="dv">1</span>], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(multiple.fit))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Creates a helper function that predicts for patient k using model i.</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>      ff <span class="ot">&lt;-</span> <span class="cf">function</span>(k,i){</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">predict.gam</span>(multiple.fit[[i]], <span class="at">newdata =</span> new.patient[k,])</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>      prediction_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">mapply</span>(ff, mygrid<span class="sc">$</span>k, mygrid<span class="sc">$</span>i),</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nrow =</span> <span class="fu">dim</span>(new.patient)[<span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">length</span>(multiple.fit))</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>      prediction <span class="ot">&lt;-</span> <span class="fu">apply</span>(prediction_matrix, <span class="dv">1</span>, mean)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(single.fit)){</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>      ff <span class="ot">&lt;-</span> <span class="cf">function</span>(k){</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">predict.gam</span>(single.fit, <span class="at">newdata =</span> new.patient[k,])</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>      prediction <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(new.patient)[<span class="dv">1</span>], ff)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prediction)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>mygrid</code> variable explanation :</p>
<ul>
<li>Creates a grid combining all patients (k) with all models (i)</li>
<li>This allows making predictions for each patient using each model</li>
</ul>
<p><code>ff</code> variable explanation :</p>
<ul>
<li>Creates a helper function that predicts for patient&nbsp;<code>k</code>&nbsp;using model&nbsp;<code>i</code>.</li>
</ul>
<p><code>prediction_matrix</code>variable explanation :</p>
<ul>
<li>Uses&nbsp;<code>mapply</code>&nbsp;to apply the prediction function to all combinations</li>
<li>Creates a matrix where rows = patients, columns = different imputed models</li>
<li>Each cell contains a prediction for that patient from that model</li>
</ul>
<p><code>prediction</code> variable explanation :</p>
<p>Takes the average prediction across all imputed models for each patient (row-wise mean). This follows multiple imputation methodology where results from different imputations are combined.</p>
<p>If only one model is provided, makes predictions for each patient using that single model.</p>
<p><strong>Overall Purpose</strong>: This function implements a complete workflow for fitting GAMs to multiple imputed datasets and making robust predictions by averaging across all fitted models, which is the standard approach in multiple imputation analysis.</p>
<p>Predict for completed data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>predicted.gam <span class="ot">&lt;-</span> <span class="fu">prediction.gam</span>(complete.data, <span class="at">multiple.fit =</span> fit.gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Predict for new patient :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="fu">prediction.gam</span>(new.patient, <span class="at">multiple.fit =</span> fit.gam))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1298759</code></pre>
</div>
</div>
</section>
<section id="third-model-ridge-regression" class="level3">
<h3 class="anchored" data-anchor-id="third-model-ridge-regression">Third Model : Ridge Regression</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>lambdas <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="fu">seq</span>(<span class="dv">2</span>, <span class="sc">-</span><span class="dv">10</span>, <span class="at">by =</span> <span class="sc">-</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creates a sequence of lambda (regularization parameter) values from 10² to 10⁻¹⁰, decreasing by steps of 0.3 on the log scale. This gives a range of regularization strengths to test.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fit.ridge <span class="ot">&lt;-</span> <span class="fu">list</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creates an empty list to store Ridge regression models - one for each imputed dataset.</p>
<p><strong>Main loop for fitting Ridge models</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.impute){</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  imp <span class="ot">&lt;-</span> imputed1[[i]]</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  imp <span class="ot">&lt;-</span> <span class="fu">with</span>(imp, <span class="fu">data.frame</span>(y, x1, x2, x3, x4, x5))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  data_glmnet <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(y <span class="sc">~</span>.,<span class="at">data =</span> imp)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  data_glmnet <span class="ot">&lt;-</span> data_glmnet[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  data_glmnet <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">y =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(imp<span class="sc">$</span>y)), <span class="at">data_glmnet =</span> data_glmnet)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(data_glmnet[,<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X)[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x3"</span>, <span class="st">"x4"</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> data_glmnet[,<span class="dv">1</span>]</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(data_glmnet[,<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  cvfit <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X,Y,<span class="at">family =</span> <span class="st">"binomial"</span>,<span class="at">alpha=</span><span class="dv">0</span>, <span class="at">lambda =</span> lambdas,<span class="at">nfolds=</span><span class="dv">10</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  lambda.min <span class="ot">&lt;-</span> cvfit<span class="sc">$</span>lambda.min</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  fit.ridge[[i]] <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(X,Y,<span class="at">family =</span> <span class="st">"binomial"</span>,<span class="at">alpha=</span><span class="dv">0</span>, <span class="at">lambda =</span>lambda.min)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Extracts the i-th imputed dataset</li>
<li>Creates a clean data frame with only the needed variables (y and x1-x5)</li>
<li><code>model.matrix()</code>&nbsp;creates a design matrix, automatically handling categorical variables</li>
<li>Removes the first column (intercept) since&nbsp;<code>glmnet</code>&nbsp;adds its own intercept</li>
<li>Combines the numeric response variable with the predictor matrix.</li>
<li>Creates predictor matrix&nbsp;<code>X</code>&nbsp;(excluding response)</li>
<li>Renames columns 3 and 4 to “x3” and “x4”</li>
<li>Creates response vector&nbsp;<code>Y</code></li>
<li>Performs 10-fold cross-validation to find the best lambda</li>
<li><code>alpha=0</code>&nbsp;specifies Ridge regression (L2 penalty)</li>
<li><code>family="binomial"</code>&nbsp;for logistic regression</li>
<li>Extracts the lambda that minimizes cross-validation error</li>
<li>Fits the Ridge regression model using the optimal lambda and stores it.</li>
</ul>
<p>Creates a prediction function similar to the GAM version, handling both single and multiple models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>prediction.ridge <span class="ot">&lt;-</span> <span class="cf">function</span>(new.patient, <span class="at">single.fit =</span> <span class="cn">NULL</span>, <span class="at">multiple.fit =</span> <span class="cn">NULL</span>) {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(multiple.fit)) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    mygrid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">k =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(new.patient)[<span class="dv">1</span>], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(multiple.fit))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    ff <span class="ot">&lt;-</span> <span class="cf">function</span>(k, i) {</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>      imp <span class="ot">&lt;-</span> <span class="fu">with</span>(new.patient, <span class="fu">data.frame</span>(</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        x1[k], x2[k], x3[k], x4[k],</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">x52 =</span> x5[k] <span class="sc">==</span> <span class="dv">2</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">x53 =</span> x5[k] <span class="sc">==</span> <span class="dv">3</span>,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">x54 =</span> x5[k] <span class="sc">==</span> <span class="dv">4</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>      imp[, <span class="dv">3</span><span class="sc">:</span><span class="dv">7</span>] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(imp[, <span class="dv">3</span><span class="sc">:</span><span class="dv">7</span>], as.numeric)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">colnames</span>(imp) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">"x"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>), <span class="st">"x52"</span>, <span class="st">"x53"</span>, <span class="st">"x54"</span>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">predict</span>(multiple.fit[[i]], <span class="at">newx =</span> <span class="fu">as.matrix</span>(imp))</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    prediction_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mapply</span>(ff, mygrid<span class="sc">$</span>k, mygrid<span class="sc">$</span>i),</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">nrow =</span> <span class="fu">dim</span>(new.patient)[<span class="dv">1</span>],</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">ncol =</span> <span class="fu">length</span>(multiple.fit)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    prediction <span class="ot">&lt;-</span> <span class="fu">apply</span>(prediction_matrix, <span class="dv">1</span>, mean)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(single.fit)) {</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    ff <span class="ot">&lt;-</span> <span class="cf">function</span>(k) {</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>      imp <span class="ot">&lt;-</span> <span class="fu">with</span>(new.patient, <span class="fu">data.frame</span>(</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        x1[k], x2[k], x3[k], x4[k],</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">x52 =</span> x5[k] <span class="sc">==</span> <span class="dv">2</span>,</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">x53 =</span> x5[k] <span class="sc">==</span> <span class="dv">3</span>,</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">x54 =</span> x5[k] <span class="sc">==</span> <span class="dv">4</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>      imp[, <span class="dv">3</span><span class="sc">:</span><span class="dv">7</span>] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(imp[, <span class="dv">3</span><span class="sc">:</span><span class="dv">7</span>], as.numeric)</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">colnames</span>(imp) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">"x"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>), <span class="st">"x52"</span>, <span class="st">"x53"</span>, <span class="st">"x54"</span>)</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">predict</span>(single.fit, <span class="at">newx =</span> <span class="fu">as.matrix</span>(imp))</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    prediction <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(new.patient)[<span class="dv">1</span>], ff)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prediction)</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>ff</code> function explanation :</p>
<ul>
<li>Takes patient&nbsp;<code>k</code>&nbsp;and model&nbsp;<code>i</code></li>
<li>Creates dummy variables for&nbsp;<code>x5</code>&nbsp;(assumes it’s categorical with levels 1,2,3,4)</li>
<li><code>x52</code>,&nbsp;<code>x53</code>,&nbsp;<code>x54</code>&nbsp;are indicators for x5=2, x5=3, x5=4 respectively</li>
<li>Converts to numeric and sets proper column names</li>
<li>Makes prediction using the specified model</li>
</ul>
<p>Prediction Matrix :</p>
<ul>
<li>Creates matrix of predictions (patients × models)</li>
<li>Averages across models for each patient (multiple imputation combining)</li>
</ul>
<p>Fit the ridge regression for completed data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>predicted.ridge <span class="ot">&lt;-</span> <span class="fu">prediction.ridge</span>(complete.data, <span class="at">multiple.fit =</span>fit.ridge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fit the ridge regression for new patient</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="fu">prediction.ridge</span>(new.patient, <span class="at">multiple.fit =</span> fit.ridge))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1728987</code></pre>
</div>
</div>
</section>
<section id="model-comparison" class="level3">
<h3 class="anchored" data-anchor-id="model-comparison">Model Comparison</h3>
<p>Creates comparison plots between three different modeling approaches.</p>
<p>Defines the axis limits for all plots. Both x and y axes will range from -5 to 3, ensuring all plots have the same scale for fair comparison.</p>
<p><strong>First plot: GAM vs Logistic Regression</strong></p>
<p>This creates a scatter plot comparing:</p>
<ul>
<li><strong>X-axis</strong>: Predictions from logistic regression (<code>predicted.lr</code>)</li>
<li><strong>Y-axis</strong>: Predictions from GAM (<code>predicted.gam</code>)</li>
<li><strong>Points</strong>: Each point represents one observation/patient</li>
<li><strong>Diagonal line</strong>: The dashed line with slope=1 and intercept=0 represents perfect agreement</li>
<li><strong>Interpretation</strong>: Points close to the diagonal line indicate similar predictions between methods</li>
</ul>
<p><strong>Second plot: Logistic Regression vs Ridge Regression</strong></p>
<p>This creates a scatter plot comparing:</p>
<ul>
<li><strong>X-axis</strong>: Predictions from Ridge regression (<code>predicted.ridge</code>)</li>
<li><strong>Y-axis</strong>: Predictions from logistic regression (<code>predicted.lr</code>)</li>
<li>Same diagonal reference line for perfect agreement</li>
</ul>
<p><strong>Third plot: GAM vs Ridge Regression</strong></p>
<p>This creates a scatter plot comparing:</p>
<ul>
<li><strong>X-axis</strong>: Predictions from Ridge regression (<code>predicted.ridge</code>)</li>
<li><strong>Y-axis</strong>: Predictions from GAM (<code>predicted.gam</code>)</li>
<li>Same diagonal reference line</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>axislim1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">3</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">predicted.gam =</span> predicted.gam,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">predicted.lr =</span> predicted.lr),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> predicted.lr, <span class="at">y =</span> predicted.gam)) <span class="sc">+</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(axislim1) <span class="sc">+</span> <span class="fu">ylim</span>(axislim1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">predicted.lr =</span> predicted.lr,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">predicted.ridge =</span> predicted.ridge),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> predicted.ridge, <span class="at">y =</span> predicted.lr)) <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(axislim1) <span class="sc">+</span> <span class="fu">ylim</span>(axislim1)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">predicted.gam =</span> predicted.gam,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">predicted.ridge =</span> predicted.ridge),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> predicted.ridge, <span class="at">y =</span> predicted.gam)) <span class="sc">+</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(axislim1) <span class="sc">+</span> <span class="fu">ylim</span>(axislim1)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, p3, <span class="at">ncol =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values or values outside the scale range
(`geom_point()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values or values outside the scale range
(`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="part1.2_precision_medicine_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="what-to-look-for-in-the-results" class="level2">
<h2 class="anchored" data-anchor-id="what-to-look-for-in-the-results">What to look for in the results:</h2>
<ul>
<li><strong>High correlation</strong>: Points tightly clustered around the diagonal line</li>
<li><strong>Bias</strong>: Points systematically above/below the diagonal</li>
<li><strong>Outliers</strong>: Points far from the diagonal where methods strongly disagree</li>
<li><strong>Range differences</strong>: Whether one method produces more extreme predictions than another</li>
</ul>
<p>This type of visualization is common in model validation to assess whether different statistical approaches yield consistent results, which can increase confidence in the findings.</p>
</section>
<section id="calculate-apparent-performance-of-the-models" class="level2">
<h2 class="anchored" data-anchor-id="calculate-apparent-performance-of-the-models">Calculate Apparent Performance of The Models</h2>
<p>For binary outcomes we need to assess performance in terms of discrimination and calibration. We will use the <strong>pROC</strong> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>apparent.auc.LR <span class="ot">&lt;-</span><span class="fu">auc</span>(complete.data<span class="sc">$</span>y<span class="sc">~</span>predicted.lr)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>apparent.auc.gam <span class="ot">&lt;-</span><span class="fu">auc</span>(complete.data<span class="sc">$</span>y<span class="sc">~</span>predicted.gam)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>apparent.auc.ridge <span class="ot">&lt;-</span><span class="fu">auc</span>(complete.data<span class="sc">$</span>y<span class="sc">~</span>predicted.ridge)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">#calibration in the large</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(complete.data<span class="sc">$</span>y<span class="sc">==</span><span class="st">"1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.26</code></pre>
</div>
</div>
<p>These calculate the apparent AUC for each model using the predicted values against the actual outcomes (<code>y</code>). The term “apparent” suggests these are calculated on the same data used to train the models, which can lead to overly optimistic performance estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">expit</span>(predicted.lr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2474065</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">expit</span>(predicted.gam))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2464704</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">expit</span>(predicted.ridge))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.212549</code></pre>
</div>
</div>
<p>We see that the mean estimated event rate by ridge is quite off. Next, we fit calibration lines and calculate AUC.</p>
<p>Now, we would like to calculate and evaluate model performance by combining discrimination and calibration metrics into a single assessment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>calculate_performance2 <span class="ot">&lt;-</span> <span class="cf">function</span>(observed, predicted){</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">auc</span>(observed<span class="sc">~</span>predicted)                                  <span class="co"># Discrimination</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    glm.fit <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">glm</span>(observed<span class="sc">~</span>predicted, <span class="at">family =</span> binomial))  <span class="co"># Calibration model</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    calibration.intercept <span class="ot">&lt;-</span> glm.fit<span class="sc">$</span>coef[<span class="dv">1</span>,<span class="dv">1</span>]                      <span class="co"># Calibration intercept</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    calibration.slope <span class="ot">&lt;-</span> glm.fit<span class="sc">$</span>coef[<span class="dv">2</span>,<span class="dv">1</span>]                          <span class="co"># Calibration slope</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    vec <span class="ot">&lt;-</span> <span class="fu">c</span>(auc, calibration.intercept, calibration.slope)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(vec) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"auc"</span>, <span class="st">"calibration intercept"</span>, <span class="st">"calibration slope"</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(vec)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="what-each-metric-means" class="level3">
<h3 class="anchored" data-anchor-id="what-each-metric-means">What Each Metric Means</h3>
<p><strong>1. AUC (Area Under the Curve):</strong></p>
<ul>
<li>Measures discrimination - how well the model separates positive from negative cases</li>
<li>Range: 0.5 (no discrimination) to 1.0 (perfect discrimination)</li>
<li>Values &gt;0.7 generally considered acceptable, &gt;0.8 good</li>
</ul>
<p><strong>2. Calibration Intercept:</strong></p>
<ul>
<li>Measures “calibration-in-the-large”</li>
<li>Ideally should be 0</li>
<li>Positive values: model systematically under-predicts risk</li>
<li>Negative values: model systematically over-predicts risk</li>
</ul>
<p><strong>3. Calibration Slope:</strong></p>
<ul>
<li>Measures how well predicted probabilities match observed frequencies across risk levels</li>
<li>Ideally should be 1</li>
<li>Slope &lt; 1: predictions are too extreme (overconfident)</li>
<li>Slope &gt; 1: predictions are too conservative (underconfident)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>apparent.lr <span class="ot">&lt;-</span> <span class="fu">calculate_performance2</span>(complete.data<span class="sc">$</span>y, predicted.lr)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>apparent.gam <span class="ot">&lt;-</span> <span class="fu">calculate_performance2</span>(complete.data<span class="sc">$</span>y, predicted.gam)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>apparent.ridge <span class="ot">&lt;-</span> <span class="fu">calculate_performance2</span>(complete.data<span class="sc">$</span>y, predicted.ridge)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">rbind</span>(apparent.lr, apparent.gam, apparent.ridge),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                auc calibration intercept calibration slope
apparent.lr    0.78                  0.16              1.07
apparent.gam   0.79                  0.19              1.11
apparent.ridge 0.77                  0.86              1.48</code></pre>
</div>
</div>
<p>We can also assess performance using the val.prob function in <strong>rms</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">val.prob</span>(<span class="at">y=</span><span class="fu">as.numeric</span>(complete.data<span class="sc">$</span>y)<span class="sc">-</span><span class="dv">1</span>,<span class="at">p=</span><span class="fu">expit</span>(predicted.lr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="part1.2_precision_medicine_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>          Dxy       C (ROC)            R2             D      D:Chi-sq 
 5.550936e-01  7.775468e-01  2.933451e-01  2.182681e-01  4.465361e+01 
          D:p             U      U:Chi-sq           U:p             Q 
 2.351630e-11 -8.128936e-03  3.742129e-01  8.293554e-01  2.263970e-01 
        Brier     Intercept         Slope          Emax           E90 
 1.470492e-01  1.563125e-01  1.074939e+00  1.259499e-01  6.798496e-02 
         Eavg           S:z           S:p 
 3.481609e-02 -7.197824e-02  9.426192e-01 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">val.prob</span>(<span class="at">y=</span><span class="fu">as.numeric</span>(complete.data<span class="sc">$</span>y)<span class="sc">-</span><span class="dv">1</span>,<span class="at">p=</span><span class="fu">expit</span>(predicted.gam))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="part1.2_precision_medicine_files/figure-html/unnamed-chunk-27-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>          Dxy       C (ROC)            R2             D      D:Chi-sq 
 5.704262e-01  7.852131e-01  3.079401e-01  2.307924e-01  4.715847e+01 
          D:p             U      U:Chi-sq           U:p             Q 
 6.547318e-12 -7.165347e-03  5.669307e-01  7.531692e-01  2.379577e-01 
        Brier     Intercept         Slope          Emax           E90 
 1.451403e-01  1.948586e-01  1.107522e+00  1.457978e-01  7.329041e-02 
         Eavg           S:z           S:p 
 3.436535e-02 -1.420079e-01  8.870738e-01 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">val.prob</span>(<span class="at">y=</span><span class="fu">as.numeric</span>(complete.data<span class="sc">$</span>y)<span class="sc">-</span><span class="dv">1</span>,<span class="at">p=</span><span class="fu">expit</span>(predicted.ridge))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="part1.2_precision_medicine_files/figure-html/unnamed-chunk-27-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         Dxy      C (ROC)           R2            D     D:Chi-sq          D:p 
5.449584e-01 7.724792e-01 2.191587e-01 1.569248e-01 3.238496e+01 1.264617e-08 
           U     U:Chi-sq          U:p            Q        Brier    Intercept 
2.093316e-02 6.186632e+00 4.535132e-02 1.359916e-01 1.608297e-01 8.569123e-01 
       Slope         Emax          E90         Eavg          S:z          S:p 
1.481701e+00 3.779620e-01 1.751923e-01 5.245168e-02 5.783124e-01 5.630532e-01 </code></pre>
</div>
</div>
<p>Then, we will create calibration plot. <strong>Calibration plot</strong>&nbsp;(also called a reliability diagram) to visually assess how well the logistic regression model’s predicted probabilities match the observed event rates across different risk levels.</p>
<p>Creates a dataframe with observed outcomes (<code>y</code>) and predicted probabilities (converted from log-odds using&nbsp;<code>expit()</code>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>df.calibration <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> complete.data<span class="sc">$</span>y, <span class="at">predicted.lr =</span> <span class="fu">expit</span>(predicted.lr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Divides patients into 10 groups based on predicted risk (deciles)</li>
<li><code>d1</code>&nbsp;contains the quantile boundaries (0%, 10%, 20%, …, 100%)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>Ngroups <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(df.calibration<span class="sc">$</span>predicted.lr, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>Ngroups))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creates 10 groups where each contains patients with similar predicted risks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>g1<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Ngroups) {</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    g1[[i]] <span class="ot">&lt;-</span> df.calibration[df.calibration<span class="sc">$</span>predicted.lr <span class="sc">&gt;=</span> d1[i] <span class="sc">&amp;</span> </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>                              df.calibration<span class="sc">$</span>predicted.lr <span class="sc">&lt;</span> d1[i<span class="sc">+</span><span class="dv">1</span>],]</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For each group, calculates:</p>
<ul>
<li>Average predicted probability</li>
<li>Actual proportion of events that occurred</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>predicted <span class="ot">&lt;-</span> observed <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"numeric"</span>, <span class="at">length =</span> Ngroups)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Ngroups) {</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    predicted[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(g1[[i]]<span class="sc">$</span>predicted.lr)    <span class="co"># Mean predicted probability</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    observed[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(g1[[i]]<span class="sc">$</span>y <span class="sc">==</span> <span class="dv">1</span>)           <span class="co"># Observed event rate</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we will create the calibration plot</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>dat1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">pred =</span> predicted, <span class="at">obs =</span> observed)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat1,<span class="fu">aes</span>(<span class="at">x=</span>pred,<span class="at">y=</span>obs))<span class="sc">+</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">3</span>,<span class="at">shape=</span><span class="dv">20</span>)<span class="sc">+</span>                           <span class="co"># Data points</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept=</span><span class="dv">0</span>,<span class="at">slope=</span><span class="dv">1</span>,<span class="at">linetype=</span><span class="st">"dashed"</span>)<span class="sc">+</span>    <span class="co"># Perfect calibration line</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method=</span><span class="st">"lm"</span>,<span class="at">colour=</span><span class="st">"blue"</span>)<span class="sc">+</span>                <span class="co"># Fitted calibration line</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">aspect.ratio=</span><span class="dv">1</span>)                                  <span class="co"># Square plot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="part1.2_precision_medicine_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="interpretation" class="level2">
<h2 class="anchored" data-anchor-id="interpretation">Interpretation</h2>
<ul>
<li><strong>Perfect calibration</strong>: Points lie on the diagonal dashed line (predicted = observed)</li>
<li><strong>Systematic miscalibration</strong>: Points consistently above/below diagonal</li>
<li><strong>Blue fitted line</strong>: Shows the calibration slope
<ul>
<li><p>Slope = 1: well calibrated</p></li>
<li><p>Slope &lt; 1: overconfident predictions (spread too wide)</p></li>
<li><p>Slope &gt; 1: underconfident predictions (too narro<br>
</p></li>
</ul></li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>