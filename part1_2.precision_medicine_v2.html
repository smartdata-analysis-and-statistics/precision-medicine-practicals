<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Model Development (Binary Outcomes)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="part1_2.precision_medicine_v2_files/libs/clipboard/clipboard.min.js"></script>
<script src="part1_2.precision_medicine_v2_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="part1_2.precision_medicine_v2_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="part1_2.precision_medicine_v2_files/libs/quarto-html/popper.min.js"></script>
<script src="part1_2.precision_medicine_v2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="part1_2.precision_medicine_v2_files/libs/quarto-html/anchor.min.js"></script>
<link href="part1_2.precision_medicine_v2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="part1_2.precision_medicine_v2_files/libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="part1_2.precision_medicine_v2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="part1_2.precision_medicine_v2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="part1_2.precision_medicine_v2_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#summary" id="toc-summary" class="nav-link active" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#key-sections" id="toc-key-sections" class="nav-link" data-scroll-target="#key-sections">Key Sections :</a>
  <ul class="collapse">
  <li><a href="#univariate-model" id="toc-univariate-model" class="nav-link" data-scroll-target="#univariate-model">1. Univariate Model</a></li>
  <li><a href="#univariate-model-with-categorize-variable" id="toc-univariate-model-with-categorize-variable" class="nav-link" data-scroll-target="#univariate-model-with-categorize-variable">2. Univariate Model with Categorize Variable</a></li>
  <li><a href="#univariate-variable-regression-spline" id="toc-univariate-variable-regression-spline" class="nav-link" data-scroll-target="#univariate-variable-regression-spline">Univariate Variable : Regression Spline</a></li>
  <li><a href="#multivariate-model" id="toc-multivariate-model" class="nav-link" data-scroll-target="#multivariate-model">2. Multivariate Model</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Model Development (Binary Outcomes)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>After preparing the data, the next step will be modelling. Modeling helps us understand how variables relate to each other. Models allow us to predict outcomes for new observations. Any prediction function demonstrates this - it takes new patient data and estimates their probability of the outcome occurring. This is crucial for clinical decision-making.</p>
</section>
<section id="key-sections" class="level1">
<h1>Key Sections :</h1>
<p>This part 1.2 Modelling will consist of some sections :</p>
<ul>
<li>Choosing a modelling strategy</li>
<li>Building The Model</li>
<li>Assessing model performance including AUC, Calibration Plot</li>
<li>Assessing performance using validation metrics</li>
</ul>
<p>Load the library</p>
<section id="univariate-model" class="level3">
<h3 class="anchored" data-anchor-id="univariate-model">1. Univariate Model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">=</span> <span class="fu">glm</span>(y<span class="sc">~</span>x1, df, <span class="at">family=</span><span class="st">'binomial'</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = y ~ x1, family = "binomial", data = df)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  -1.5686     0.2307  -6.798 1.06e-11 ***
x1            1.6137     0.2753   5.861 4.59e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 229.22  on 199  degrees of freedom
Residual deviance: 175.30  on 198  degrees of freedom
AIC: 179.3

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<ul>
<li><p>For <strong>each 1-unit increase in <code>x1</code></strong>, the <strong>log-odds</strong> of <code>y = 1</code> increase by <strong>1.61</strong>.</p></li>
<li><p>In terms of <strong>odds ratio</strong>:</p>
<p>OR = exp⁡(1.6137) ≈ 5.02</p>
<p>So each unit increase in <code>x1</code> multiplies the odds of <code>y = 1</code> by <strong>5.02×</strong>.</p></li>
<li><p>Strong and statistically significant association (p-value = <code>4.59e-09</code>).</p></li>
</ul>
</section>
<section id="univariate-model-with-categorize-variable" class="level3">
<h3 class="anchored" data-anchor-id="univariate-model-with-categorize-variable">2. Univariate Model with Categorize Variable</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>x1_bin <span class="ot">&lt;-</span> <span class="fu">cut</span>(df<span class="sc">$</span>x1, </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">breaks =</span> <span class="fu">quantile</span>(df<span class="sc">$</span>x1, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.2</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Bottom 20%"</span>, <span class="st">"20-40%"</span>, <span class="st">"40-60%"</span>, <span class="st">"60-80%"</span>, <span class="st">"Top 20%"</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>x1_bin <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>x1_bin) </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(df<span class="sc">$</span>x1_bin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Bottom 20%     20-40%     40-60%     60-80%    Top 20% 
        40         40         40         40         40 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1_bin, <span class="at">data =</span> df, <span class="at">family =</span> binomial)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = y ~ x1_bin, family = binomial, data = df)

Coefficients:
              Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)    -2.5123     0.6003  -4.185 2.85e-05 ***
x1_bin20-40%   -0.4321     0.9416  -0.459  0.64628    
x1_bin40-60%    0.5664     0.7674   0.738  0.46048    
x1_bin60-80%    2.2100     0.6802   3.249  0.00116 ** 
x1_binTop 20%   3.0231     0.6834   4.424 9.70e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 229.22  on 199  degrees of freedom
Residual deviance: 174.81  on 195  degrees of freedom
AIC: 184.81

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>odds_ratios <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">coef</span>(model2))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(odds_ratios)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  (Intercept)  x1_bin20-40%  x1_bin40-60%  x1_bin60-80% x1_binTop 20% 
   0.08108108    0.64912281    1.76190476    9.11594203   20.55555556 </code></pre>
</div>
</div>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th>Bin</th>
<th>Coefficient</th>
<th>OR</th>
<th>p-value</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Intercept (Bottom 20%)</td>
<td>-2.51</td>
<td>OR = 0.081</td>
<td>&lt;0.001</td>
<td>Odds of&nbsp;<code>y=1</code>&nbsp;in the&nbsp;<strong>lowest 20% of x1</strong></td>
</tr>
<tr class="even">
<td>20–40%</td>
<td>-0.4321</td>
<td>OR = 0.649</td>
<td>0.646</td>
<td>No significant difference from reference</td>
</tr>
<tr class="odd">
<td>40–60%</td>
<td>0.5664</td>
<td>OR = 1.76</td>
<td>0.460</td>
<td>Not significant</td>
</tr>
<tr class="even">
<td>60–80%</td>
<td>2.2100</td>
<td>OR = 9.12</td>
<td><strong>0.001</strong></td>
<td>Odds of&nbsp;<code>y = 1</code>&nbsp;are ~9× higher than bottom 20%</td>
</tr>
<tr class="odd">
<td>Top 20%</td>
<td>3.0231</td>
<td>OR = 20.56</td>
<td><strong>&lt;0.001</strong></td>
<td>Odds of&nbsp;<code>y = 1</code>&nbsp;are&nbsp;<strong>~20× higher</strong>&nbsp;than bottom 20%</td>
</tr>
</tbody>
</table>
<p><strong>Model Comparison</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric</th>
<th>Model 1 (<code>x1</code>)</th>
<th>Model 2 (<code>x1_bin</code>)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>AIC</td>
<td>179.3</td>
<td>184.8</td>
</tr>
<tr class="even">
<td>Residual Deviance</td>
<td>175.30</td>
<td>174.81</td>
</tr>
<tr class="odd">
<td>Interpretability</td>
<td>Simple, linear</td>
<td>Nonlinear insight</td>
</tr>
<tr class="even">
<td>Flexibility</td>
<td>Assumes linearity</td>
<td>Captures thresholds</td>
</tr>
<tr class="odd">
<td>OR Range</td>
<td>OR ≈ 5 per unit</td>
<td>ORs: 0.65 to 20.5</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Model 1 fits better (lower AIC)</strong>&nbsp;and is simpler.</li>
<li><strong>Model 2 shows a clear threshold effect</strong>: Only the top 40% of&nbsp;<code>x1</code>&nbsp;(especially top 20%) are significantly associated with high odds of&nbsp;<code>y = 1</code>.</li>
</ul>
<section id="when-to-use-which" class="level4">
<h4 class="anchored" data-anchor-id="when-to-use-which">When to use which?</h4>
<ul>
<li>Use&nbsp;<strong>Model 1</strong>&nbsp;if the relationship between&nbsp;<code>x1</code>&nbsp;and&nbsp;<code>y</code>&nbsp;is reasonably linear.</li>
<li>Use&nbsp;<strong>Model 2</strong>&nbsp;if you suspect&nbsp;<strong>non-linearities or thresholds</strong>&nbsp;(e.g., only high&nbsp;<code>x1</code>&nbsp;values drive&nbsp;<code>y = 1</code>).</li>
</ul>
</section>
</section>
<section id="univariate-variable-regression-spline" class="level3">
<h3 class="anchored" data-anchor-id="univariate-variable-regression-spline">Univariate Variable : Regression Spline</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dd <span class="ot">&lt;-</span> <span class="fu">datadist</span>(df)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datadist =</span> <span class="st">"dd"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">lrm</span>(y <span class="sc">~</span> <span class="fu">rcs</span>(x1, <span class="dv">3</span>), <span class="at">data =</span> df, <span class="at">y =</span> <span class="cn">TRUE</span>, <span class="at">x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Effects              Response : y 

 Factor      Low      High    Diff.  Effect S.E.    Lower 0.95 Upper 0.95
 x1          -0.59029 0.73247 1.3228 1.9393 0.37693 1.2006      2.6781   
  Odds Ratio -0.59029 0.73247 1.3228 6.9540      NA 3.3220     14.5570   </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">Predict</span>(model3, x1, <span class="at">fun =</span> plogis), <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="part1_2.precision_medicine_v2_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><p><code>x1</code>&nbsp;was modeled&nbsp;<strong>non-linearly</strong>&nbsp;using&nbsp;<strong>restricted cubic splines with 3 knots</strong>.</p></li>
<li><p>The row shows the&nbsp;<strong>effect of increasing&nbsp;<code>x1</code></strong>&nbsp;from its&nbsp;<strong>Low value (-0.59)</strong>&nbsp;to its&nbsp;<strong>High value (0.73)</strong>.</p></li>
<li><p>The&nbsp;<strong>log-odds</strong>&nbsp;increase by&nbsp;<strong>1.9393</strong>, corresponding to an&nbsp;<strong>odds ratio of ~6.95</strong>.</p>
<p>Odds&nbsp;Ratio=exp⁡(1.9393)≈6.95</p></li>
<li><p>95% CI for the odds ratio:&nbsp;<strong>[3.32, 14.56]</strong><br>
→ This is statistically significant and shows a strong effect across the range of&nbsp;<code>x1</code>.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(model1, model2, model3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       df      AIC
model1  2 179.2980
model2  5 184.8070
model3  3 180.3067</code></pre>
</div>
</div>
<ul>
<li><strong>Model 1 (linear)</strong>&nbsp;has the lowest AIC — simplest and best overall fit.</li>
<li><strong>Model 3 (spline)</strong>&nbsp;is&nbsp;<strong>almost as good</strong>&nbsp;(AIC just +1),&nbsp;<strong>but more flexible</strong>&nbsp;and&nbsp;<strong>captures non-linear effects</strong>.</li>
<li><strong>Model 2 (binned)</strong>&nbsp;is worst — binning introduces sharp cutoffs and more parameters, which can hurt generalization.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. PREDICTED PROBABILITIES COMPARISON</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create prediction data</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>x1_range <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(df<span class="sc">$</span>x1, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="fu">max</span>(df<span class="sc">$</span>x1, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x1 =</span> x1_range)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Add binned variable for model2</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>pred_data<span class="sc">$</span>x1_bin <span class="ot">&lt;-</span> <span class="fu">cut</span>(pred_data<span class="sc">$</span>x1, </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">breaks =</span> <span class="fu">quantile</span>(pred_data<span class="sc">$</span>x1, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.2</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Bottom 20%"</span>, <span class="st">"20-40%"</span>, <span class="st">"40-60%"</span>, <span class="st">"60-80%"</span>, <span class="st">"Top 20%"</span>),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions from each model</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>pred_data<span class="sc">$</span>model1_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(model1, pred_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>pred_data<span class="sc">$</span>model2_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(model2, pred_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co"># For model3 (rms package)</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>pred_data<span class="sc">$</span>model3_prob <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">predict</span>(model3, pred_data))</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>y_numeric <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(df<span class="sc">$</span>y))</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Predicted Probabilities</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pred_data, <span class="fu">aes</span>(<span class="at">x =</span> x1)) <span class="sc">+</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model1_prob, <span class="at">color =</span> <span class="st">"Linear (Model 1)"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model2_prob, <span class="at">color =</span> <span class="st">"Binned (Model 2)"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model3_prob, <span class="at">color =</span> <span class="st">"Spline (Model 3)"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> df, <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> y_numeric), <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predicted Probabilities Comparison"</span>,</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"X1 Value"</span>, </span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Predicted Probability"</span>,</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Model"</span>) <span class="sc">+</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="part1_2.precision_medicine_v2_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Interpretation:</strong></p>
<ul>
<li><strong>Blue line (Linear)</strong>: Straight increase in probability with&nbsp;<code>x1</code>.</li>
<li><strong>Red dashed line (Binned)</strong>: Step-wise jumps by bin.</li>
<li><strong>Green dotted line (Spline)</strong>: Smooth, flexible fit that can reveal non-linear patterns.</li>
</ul>
</section>
<section id="multivariate-model" class="level3">
<h3 class="anchored" data-anchor-id="multivariate-model">2. Multivariate Model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">=</span> <span class="fu">glm</span>(y<span class="sc">~</span>x1<span class="sc">+</span>x2<span class="sc">+</span>x3<span class="sc">+</span>x4<span class="sc">+</span>x5, df, <span class="at">family=</span><span class="st">'binomial'</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = y ~ x1 + x2 + x3 + x4 + x5, family = "binomial", 
    data = df)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  -1.4740     0.5031  -2.930  0.00339 ** 
x1            1.5514     0.3056   5.076 3.86e-07 ***
x2            0.1240     0.2446   0.507  0.61209    
x31           0.3845     0.4445   0.865  0.38704    
x41          -0.5616     0.4164  -1.349  0.17743    
x52           0.1054     0.5659   0.186  0.85221    
x53          -0.2656     0.5883  -0.451  0.65166    
x54           0.2856     0.6742   0.424  0.67182    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 229.22  on 199  degrees of freedom
Residual deviance: 171.43  on 192  degrees of freedom
AIC: 187.43

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>model5 <span class="ot">=</span> <span class="fu">lrm</span>(y<span class="sc">~</span><span class="fu">rcs</span>(x1,<span class="dv">3</span>)<span class="sc">+</span><span class="fu">rcs</span>(x2,<span class="dv">3</span>)<span class="sc">+</span>x3<span class="sc">+</span>x4<span class="sc">+</span>x5, <span class="at">data =</span> df, <span class="at">y =</span> <span class="cn">TRUE</span>, <span class="at">x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Effects              Response : y 

 Factor      Low      High    Diff.  Effect    S.E.    Lower 0.95 Upper 0.95
 x1          -0.59029 0.73247 1.3228  1.846000 0.40797  1.04640    2.64560  
  Odds Ratio -0.59029 0.73247 1.3228  6.334400      NA  2.84730   14.09200  
 x2          -0.59374 0.69973 1.2935  0.134970 0.32826 -0.50840    0.77834  
  Odds Ratio -0.59374 0.69973 1.2935  1.144500      NA  0.60146    2.17780  
 x3 - 1:0     1.00000 2.00000     NA  0.452770 0.45377 -0.43660    1.34210  
  Odds Ratio  1.00000 2.00000     NA  1.572700      NA  0.64623    3.82720  
 x4 - 1:0     1.00000 2.00000     NA -0.622890 0.42434 -1.45460    0.20879  
  Odds Ratio  1.00000 2.00000     NA  0.536390      NA  0.23350    1.23220  
 x5 - 1:2     2.00000 1.00000     NA -0.066717 0.57247 -1.18870    1.05530  
  Odds Ratio  2.00000 1.00000     NA  0.935460      NA  0.30461    2.87280  
 x5 - 3:2     2.00000 3.00000     NA -0.316410 0.49091 -1.27860    0.64575  
  Odds Ratio  2.00000 3.00000     NA  0.728760      NA  0.27844    1.90740  
 x5 - 4:2     2.00000 4.00000     NA  0.202430 0.57748 -0.92941    1.33430  
  Odds Ratio  2.00000 4.00000     NA  1.224400      NA  0.39479    3.79720  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(model4, model5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       df      AIC
model4  8 187.4261
model5 10 190.1752</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. PREDICTED PROBABILITIES COMPARISON</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create prediction data</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">seq</span>(<span class="fu">min</span>(df<span class="sc">$</span>x1, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="fu">max</span>(df<span class="sc">$</span>x1, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">length.out =</span> <span class="dv">100</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">mean</span>(df<span class="sc">$</span>x2, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">x3 =</span> <span class="fu">factor</span>(<span class="dv">0</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">x4 =</span> <span class="fu">factor</span>(<span class="dv">0</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)),</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">x5 =</span> <span class="fu">factor</span>(<span class="dv">1</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>))</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Add binned variable for model2</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>pred_data<span class="sc">$</span>x1_bin <span class="ot">&lt;-</span> <span class="fu">cut</span>(pred_data<span class="sc">$</span>x1, </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">breaks =</span> <span class="fu">quantile</span>(pred_data<span class="sc">$</span>x1, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.2</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Bottom 20%"</span>, <span class="st">"20-40%"</span>, <span class="st">"40-60%"</span>, <span class="st">"60-80%"</span>, <span class="st">"Top 20%"</span>),</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions from each model</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>pred_data<span class="sc">$</span>model1_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(model1, pred_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>pred_data<span class="sc">$</span>model2_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(model2, pred_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="co"># For model3 (rms package)</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>pred_data<span class="sc">$</span>model3_prob <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">predict</span>(model3, pred_data))</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>pred_data<span class="sc">$</span>model4_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(model4, pred_data,<span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>pred_data<span class="sc">$</span>model5_prob <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">predict</span>(model5, pred_data))</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>y_numeric <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(df<span class="sc">$</span>y))</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Predicted Probabilities</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pred_data, <span class="fu">aes</span>(<span class="at">x =</span> x1)) <span class="sc">+</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model1_prob, <span class="at">color =</span> <span class="st">"Linear (Model 1)"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model2_prob, <span class="at">color =</span> <span class="st">"Binned (Model 2)"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model3_prob, <span class="at">color =</span> <span class="st">"Spline (Model 3)"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model4_prob, <span class="at">color =</span> <span class="st">"Multivariate (Model 4)"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model5_prob, <span class="at">color =</span> <span class="st">"Multivariate Spline (Model 5)"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> df, <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> y_numeric), <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predicted Probabilities Comparison"</span>,</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"X1 Value"</span>, </span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Predicted Probability"</span>,</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Model"</span>) <span class="sc">+</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="part1_2.precision_medicine_v2_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>